
âŸ¨GnuplotâŸ© â† â€¢Import "Gnuplot.bqn"

âŸ¨JParseâ‡Parse,JExportâ‡ExportâŸ©â†â€¢Import "bqn-libs/json.bqn"
âŸ¨Split , Join,  SplitL, JoinLâŸ©â†â€¢Import "bqn-libs/csv.bqn"
âŸ¨MP, Cholesky,InverseâŸ©â†â€¢Import "bqn-libs/matrix.bqn"
#1â€¿1 MP 2â€¿2â¥Š4
âŸ¨FmtNs, GLine, WMean, Ema, Var, WVar, WStd, GBars, CumBins, CumBinsPct, HBins, Hist, PHistâŸ©â†â€¢Import "pk-libs.bqn"

csv â† "',/" â€¢Import "./bqn-libs/csv.bqn"  # Easier characters to write
csvdir â† "/media/grenada/Data/Crypto-Historical-Data/data-csv/binance/"

LdCsv â† { 
	baseâ€¿quoteâ†ğ•¨â‹„
	timeframeâ†ğ•©â‹„
	>â€¢ParseFloatÂ¨Â¨ 1â†“ csv.SplitL â€¢FLines csvdir âˆ¾baseâˆ¾"_"âˆ¾quoteâˆ¾"-"âˆ¾timeframeâˆ¾".csv"â‹„
}
#10â†‘âŸ¨"BTC","USDT"âŸ© LoadCandles "1d"

jsondirâ†"/media/grenada/Data/Crypto-Data-Feed/freq-user-data/data/binance/"
LdJson â†{ 
	>JParse â€¢FChars jsondirâˆ¾(âŠ‘ğ•©)âˆ¾"_"âˆ¾(1âŠ‘ğ•©)âˆ¾"-"âˆ¾(ğ•¨)âˆ¾".json"
}
LdJsLc â† {â‹†â¼ Â¯2âŠË˜ ğ•¨ LdJson ğ•©â€¿"USDT"}
errmeaâ†0.1
#######################################
### Todos:
#-V Parameter sweeps, continuous and discrete
#-V Parameter deals, continuous and discrete
#- Julia Sigma Points
#- Merwe Scaled Sigma Points
#- Unscented Kalman Filter
#- UKF linear for macro
#- UKF Fib Levels
#- Markov Chains & UKF
#- RL

#######################################
### Parameter Sweeping and Dealing (random selection)

#- Divides interval in n parts
#RSweep â† ((â†•1âŠ¸+)Ã—Ã·)âŠ¸Ã—âŸœ(-Â´âŒ½)
RSweepâ† {sâ€¿eâ†ğ•©â‹„dâ†(e-s)Ã·ğ•¨â‹„s+dÃ—â†•1+ğ•¨}
10 RSweep âŸ¨5,10âŸ©
ISweep â† (âŒŠ1eÂ¯8âŠ¸+)RSweep
#10 ISweep âŸ¨0,10âŸ©


#- Covariance
 Covâ† {nâ†â‰ âŠ‘ğ•©â‹„nÃ·Ëœ+Â´Ã—Â´(âŠ¢-nÃ·Ëœ+Â´)Â¨ğ•©} 
 #Cov {aâ€¿vâ†4â€¿3â‹„(a+ğ•©Ã—v)â‹ˆ(â‰ ğ•©)â¥Šv} â†•10

#- Cholesky Decomposition
#(cholesky.DecomposeâŠ¸â‹ˆ) (MPâŸœâ‰) > {(âŒ½(-ğ•©)â†‘1+â†•)Â¨1+â†•ğ•©} 2
#cholesky.Decompose >âŸ¨âŸ¨10, 5, 2âŸ©,âŸ¨5, 3, 2âŸ©,âŸ¨2, 2, 3âŸ©âŸ©
#- Merwe Scaled Sigma Points
Merwe_Sigmas â† {
	nâ€¿aâ€¿bâ€¿k â† ğ•©
	lâ†((Ã—Ëœa)Ã—(n+k))-n 
	câ†0.5Ã·n+l
	wmâ€¿wcâ‡(0â€¿(1+b-Ã—Ëœa) + 2â¥ŠlÃ·l+n) âˆ¾Â¨ <wcoâ†(nÃ—2)â¥Šc
	Pointsâ‡{
		xâ€¿covâ†ğ•©
		x ((<âŠ£)(âŠ£âˆ¾+Â¨)âŠ¢)  <Ë˜âˆ¾Â´1â€¿Â¯1Ã—<â‰cholesky.Decompose covÃ—n+l
	}
} 
(Merwe_Sigmas 2â€¿0.1â€¿2â€¿1).Points âŸ¨3â€¿4,(>âŸ¨1â€¿0,2â€¿1âŸ©)âŸ©

#- Discrete white noise in 2-dim, check inconsistency with FilterPy
Q_dwn_2â‡ {sqâ†Ã—Ëœğ•¨â‹„ğ•©Ã— 2â€¿2â¥Š(0.25Ã—Ëœsq)âˆ¾(2â¥Š0.5Ã—sqÃ—ğ•¨)âˆ¾sq }
Q_dwn_4â† {ğ•©Ã—(ğ•¨â‹†<Ë˜âŒ½âŒ½Ë˜(â†•+2âŠ¸â¥Šâ¥Šâ†•) 4) Ã· âŸ¨36,12,6,6âŸ©â€¿âŸ¨12,4,2,2âŸ©â€¿âŸ¨6,2,2,1âŸ©â€¿âŸ¨6,2,1,1âŸ© }
#Q_dwn_2 1â€¿0.02
#- Makes a new matrix double the size, placing the argument matrix in diagonal
MkTriâ† (2â€¿2â¥Š0)âŠ¸(âˆ¾Ë˜Â´âˆ˜(âˆ¾Â¨âŒ½âŠ¸â‹ˆ)â‹ˆ) 
#MkTri 1 Q_dwn_2 0.02

Diag â† {ğ•©âŒ¾(0â€¿0âŠ¸â‰)0âŒœËœğ•©}
###- Unscented Kalman Filter
UKFâ†{
	dtâ€¿std_xâ€¿std_râ€¿âŸ¨aâ€¿bâ€¿kâŸ© â† ğ•©
	fâ†4â€¿4 â¥Š 1â€¿dtâ€¿0â€¿0â€¿0â€¿1â€¿0â€¿0â€¿0â€¿0â€¿1â€¿dtâ€¿0â€¿0â€¿0
	Fxâ†fâŠ¸MPâ‹„Hxâ†0â€¿2âŠ¸âŠâ‹„sigmaFâ‡Merwe_Sigmas 4â€¿0.1â€¿2â€¿1
	qâ† MkTri 1 Q_dwn_2 0.02â‹„râ†Diag 2â¥Šstd_râ‹†2
	x_iniâ†4â¥Š0â‹„p_iniâ†Diag 4â¥Š1
	UTâ† {
			xâ† +Â´sigmaF.wm Ã— ğ•©
			pâ† ğ•¨+ +Â´sigmaF.wc Ã— (Ã—âŒœËœ)Â¨ ğ•© - <x
			xâ€¿p
	}
	Filterâ‡{
		(<x_iniâ€¿p_ini){
			pxâ€¿ppâ† 0â€¿1âŠğ•¨	
			sigmasâ† sigmaF.Points pxâ€¿pp
			y_siâ† FxÂ¨ sigmas
			xâ€¿p â† q UT y_si
			zâ† HxÂ¨ y_si
			z_muâ€¿z_pâ† r UT z 
			siâ†Inverse z_p
			p_xzâ† +Â´sigma_F.wcÃ—(y_si-Â¨<x) (Ã—âŒœ)Â¨ (z-Â¨<z_mu)
			kâ† p_xz MP si
			z_resiâ†ğ•©-z_mu
			uxâ† x+k MP z_resi
			upâ† p-k MP z_p MP â‰k
			uxâ€¿up
		}`ğ•©
	}
} 

#- Test with data from the book
#zsâ†<Ë˜1â†“Ë˜ >â€¢ParseFloatÂ¨Â¨ 1â†“ csv.SplitL â€¢FLines "sym.csv"
#{ğ•©.Filter 10â†‘zs}UKF 1â€¿0.03â€¿0.3â€¿âŸ¨0.1â€¿2â€¿1âŸ©

###- Linear Kalman Filter
LKFâ†{
	dtâ€¿q_varâ€¿r_var â† ğ•¨
	fâ†(2â€¿2 â¥Š 1â€¿dtâ€¿0â€¿1)â‹„hâ†(â‰1â€¿0)â‹„
	qâ† 1 Q_dwn_2 q_varâ‹„
	râ†Diag 1â¥Šr_var
	x_iniâ†(âŠ‘ğ•©)â€¿0â‹„p_iniâ†Diag 2â¥Š1

	#x_iniâ†(â‰â‰10â€¿4.5) 
	#p_iniâ†Diag 500â€¿49
	(<x_iniâ€¿p_ini){
		âŸ¨px,ppâŸ©â† 0â€¿1âŠğ•¨	
		x_predâ† f MP px
		p_predâ† (f MP pp MP â‰f) + q
		sâ† (h MP p_pred MP â‰h) + r
		kâ† p_pred MP (â‰h) MP Inverse s
		yâ† ğ•© - h MP x_pred # residual
		uxâ† x_pred + k MP y
		upâ† p_pred - k MP h MP p_pred
		âŸ¨ux,upâŸ©
	}`ğ•©
} 
###- Test against the book implementation
#zsâ€¿track â† <Ë˜1â†“â‰>â€¢ParseFloatÂ¨Â¨  1â†“ csv.SplitL â€¢FLines "nofpy.csv"
#xpsâ†>{ğ•©.Filter zs} LKF 1â€¿0.01â€¿10
#- Strategy Stats
XStats â‡ {
		pnlâ€¿cumpnlâ‡ğ•©
		retâ‡Â¯1âŠ‘0âˆ¾cumpnl
		ntradesâ‡â‰ pnlâ‹„nwinsâ‡+Â´pnl>0â‹„nlossesâ‡ntrades-nwinsâ‹„winratioâ‡nwinsÃ·ntradesâ‹„
		winsâ‡(0âŠ¸<âŠ¸/)pnlâ‹„lossesâ‡(0âŠ¸â‰¥âŠ¸/)pnlâ‹„avgwinâ‡(+Â´Ã·â‰ )winsâ‹„avglossâ‡(+Â´Ã·â‰ )lossesâ‹„
		maxpnlâ‡âŒˆ`cumpnl
		ddnâ‡-maxpnl-cumpnl
		maxddnâ‡âŒŠÂ´ddn
		volâ‡âˆšVar pnl
		sharpeâ‡retÃ·vol
		toppnlâ‡âŒˆÂ´maxpnl
 	#statsâ‡>âŸ¨"#Trades:"â€¿ntrades, "#Wins:"â€¿nwinsâŸ©
 	#â€¢Show cumpnl
	#XRun â‡ {XStats XPositions XExits XEntries ğ•¨ XIndicators Xload ğ•©}
}
WPosâ† { wsâ€¿wwâ†ğ•¨â‹„weâ†ws+wwâ‹„
	ixinâ€¿ixoutâ€¿pinâ€¿poutâ€¿pnlâ€¿cumpnlâ† ğ•©

	wpmaskâ†(ixout<we)âˆ§(ixin>ws)
	wixinâ€¿wixoutâ€¿wpinâ€¿wpoutâ†{(+Â´Â¬ixinâ‰¥ws)â†“(-+Â´ixout>we)â†“ğ•©}Â¨ ixinâ€¿ixoutâ€¿pinâ€¿pout
	wcumpnlâ†+`wpnlâ†(Â¯0.002)+ -wpin-wpout
	wixinâ€¿wixoutâ€¿wpinâ€¿wpoutâ€¿wpnlâ€¿wcumpnl
}


XRun â† {
	vthrâ€¿tpthr â† ğ•¨
	posâ€¿isigâ€¿osigâ€¿pentâ†<Ë˜â‰>(<0â€¿0â€¿0â€¿0){
		in_posâ€¿sig_inâ€¿sig_outâ€¿p_inâ†ğ•¨
		oâ€¿hâ€¿lâ€¿câ€¿k1â€¿v1â†ğ•©
		xinâ†(Â¬in_pos)âˆ§ (v1>vthr) âˆ§ (c>k1) âˆ§ (l<k1)
		xoutâ†in_posâˆ§ ((c<k1) âˆ¨ (c>tpthr))
		#oâ€¿hâ€¿lâ€¿câ€¿âŸ¨k1,v1âŸ©â€¿âŸ¨k2,v2âŸ©â€¿âŸ¨k3,v3âŸ©â†ğ•©
		#xinâ†(Â¬in_pos)âˆ§ (v2>0.01) âˆ§ (v3>0.01) âˆ§(k1>k2)âˆ§(k2>k3) 
		#xoutâ†in_posâˆ§ ((k1<k2)âˆ¨(k2<k3)) #âˆ¨(Â¯0.1>c-p_in)) (0.3<c-k1)âˆ¨
		xin_posâ†(xinâˆ§Â¬in_pos)âˆ¨(in_posâˆ§Â¬xout)
		xp_inâ†(xinÃ—c)+(p_inÃ—in_pos)
		xin_posâ€¿xinâ€¿xoutâ€¿(xp_in)
	}`<Ë˜ğ•©
	ixinâ€¿ixoutâ†<Ë˜(/isig) {ğ•¨â‰ğ•©âˆ¾((â‰ ğ•¨)>â‰ ğ•©)â¥ŠÂ¯1+â‰ ğ•©} / (Â¯1âŠ¸â†“ âˆ¾ Â¯1âŠ¸âŠ‘âŸœpos) osig
	câ†3âŠ‘Ë˜ğ•© # close price
	cumpnlâ†+`pnlâ†--Â´pinâ€¿poutâ†<Ë˜(>ixinâ€¿ixout) âŠ c
	ixinâ€¿ixoutâ€¿pinâ€¿poutâ€¿pnlâ€¿cumpnl
}
#3â†‘odataâ†0.001â€¿0.01â€¿10 XInd "1d"â€¿"SOL"
#3â†‘â‰>posâ†0.01 XRun <Ë˜odata
#FmtNs XStats Â¯2â†‘pos
LnOhlcâ† {â‹†â¼ Â¯1â†“Ë˜1â†“Ë˜ ğ•¨ LdJson ğ•©â€¿"USDT"} 
lohlcâ† "1d" LnOhlc "AVAX"
#Â¯1â†‘ â†•5
### Objective function
âŠ‘1â†‘âŸ¨âŸ©
Obj â† {
	kparâ†(0âŠ‘ğ•¨)âˆ¾0âˆ¾(1âŠ‘ğ•¨)â‹„
	rparâ†Â¯2â†‘ğ•¨
	ohlc â† ğ•©
	odataâ† ohlcâˆ¾Ë˜>âŠË˜>kpar LKF Â¯1âŠË˜ ohlc
	posâ† rpar XRun odata
	#odataâ€¿pos
	âŠ‘1â†‘âŠ‘Â¯1â€¿Â¯1âŠpos
}
#0.001â€¿0.01â€¿10â€¿0.01 Obj lohlc
########################################################
### Genetic Algo
#- Deals n numbers in interval with precision
RDeal â† ((âŠ£â€¢rand.Range Â¯1âŠ¸âŠ‘)Ã—((-Â´âˆ˜âŒ½2â†‘âŠ¢)Ã·2âŠ¸âŠ‘))
#10 RDeal âŸ¨0,10,100âŸ©
#- Deals n elements from an array
ADeal â† ((âŠ£ â€¢rand.Range â‰ âˆ˜âŠ¢)âŠâŠ¢)
#40 ADeal 10Ã—â†•5
#- Example deal multiple params
#(5âŠ¸RDeal)â€¿(7âŠ¸ADeal) {ğ•ğ•©}Â¨ âŸ¨0,10,100âŸ©â€¿(5+â†•10)
### Generates random parameters, Floating Point
GenRan â†	<Ë˜âˆ˜â‰âˆ˜>((âŠ£ â€¢rand.Range (2âŠ¸âŠ‘âŠ¢))Ã—((2âŠ¸âŠ‘Ã·ËœâŸœ(1âŠ¸âŠ‘-âŠ‘))âŠ¢))Â¨ 
#3 GenRan âŸ¨1,1,1âŸ©â€¿âŸ¨0,1,100âŸ©
 #â€¢Fmt  1.123412341234
### Mutation
Mutate â† {
	râ†1+â€¢rand.Range Â¯1+â‰ âŠ‘ğ•©
	(râ†‘Â¨ğ•©) âˆ¾Â¨ râ†“Â¨(â€¢rand.Deal â‰ ğ•©) âŠ ğ•©
}
Genetic â† {
	pardefs â† ğ•©
	niterâ€¿ntopâ€¿nperâ€¿Objâ€¿opar â† ğ•¨
	#â€¢Show opar
#{ğ•© Obj opar}Â¨ 
nper GenRan pardefs
	(>{ğ•©â‹ˆğ•© Obj opar}Â¨ nper GenRan pardefs) {
		ntop â†‘ ((â’1âŠ¸âŠË˜)âŠ¸âŠ) ğ•©âˆ¾ >{ğ•©â‹ˆğ•© Obj opar}Â¨  (âŠË˜ğ•©) (Â¬âˆ˜âˆŠËœ/âŠ¢) (nper GenRan pardefs)âˆ¾(Mutate âŠË˜ğ•©)
		
	}Â´ â†•niter
 }
#{"strat-params.csv" â€¢FLines â€¢FmtÂ¨ <Ë˜ğ•©â‹„ğ•©} 100â€¿20â€¿20â€¿Objâ€¿lohlc Genetic âŸ¨1,1,1âŸ©â€¿âŸ¨0.001,0.001,1âŸ©â€¿âŸ¨1,1,1âŸ©â€¿âŸ¨0,2,100âŸ©
{"strat-params.csv" â€¢FLines â€¢ReprÂ¨  <Ë˜ğ•©â‹„ğ•©} "pars"â€¿"CumPnl"âŠ¸âˆ¾ 100â€¿20â€¿50â€¿Objâ€¿lohlc Genetic âŸ¨0,0.002,100âŸ©â€¿âŸ¨0,50,100âŸ©â€¿âŸ¨0,0.2,100âŸ©â€¿âŸ¨0,20,100âŸ©
#parsâ†âŸ¨0.9316,26.32,0,0.94âŸ©
#pars Obj lohlc

ObjS â† {
	kparâ†3â†‘ğ•¨â‹„rparâ†Â¯1âŠ‘ğ•¨
	odataâ† ğ•©âˆ¾Ë˜>âŠË˜>kpar LKF Â¯1âŠË˜ ğ•©
	posâ† rpar XRun odata
	odataâ€¿pos
	#âŠ‘1â†‘âŠ‘Â¯1â€¿Â¯1âŠpos
}
#odataâ€¿pos â† pars ObjS lohlc
#â‰>pos
#odataâ€¿pos â† "1d"â€¿"SOL" Obj (<0.001â€¿0.01â€¿10)â€¿0.01
#{stâ†ğ•©.statsâ‹„FmtNs ğ•©.statsâ‹„
#5 RSweep âŸ¨0.1,2.0âŸ©
#parsâ† {1â€¿ğ•©â€¿0.1}Â¨  Ã·10Ã—1+â†•5
#>kfsâ† { âŠ‘Ë˜âŠ‘Ë˜> ğ•© LKF Â¯1âŠË˜ lohlc}Â¨ pars
#odataâ†lohlc
#xsâ†pars (â‹ˆÂ¨) kfs
#wsâ†0â‹„weâ†(â‰ odata)â‹„wwâ†we-ws
wsâ†0â‹„weâ†400â‹„wwâ†we-ws
wodataâ†wwâ†‘wsâ†“odata
#wixinâ€¿wixoutâ€¿wpinâ€¿wpoutâ€¿wpnlâ€¿wcumpnlâ†wsâ€¿ww WPOS pos
wksâ† pars â‹ˆÂ¨ {wwâ†‘wsâ†“ğ•©}Â¨ kfs
#FmtNs XStats wpnlâ€¿wcumpnl
ixsâ† ws+â†•ww
plt â† Gnuplot "
	title 'Linear Kalman Filter' font ',18'
	terminal wxt size 2300,900
	y2tics nomirror tc lt 2
	style line 5 lt rgb 'cyan' lw 5 pt 6"
plt.Plot (ixsâˆ¾Ë˜ 4â†‘Ë˜wodata)â€¿"lw 1 with financebars title 'price'"
#plt.Plot (((âŠ‘wixin)â€¿0)âˆ¾wixoutâˆ¾Ë˜wcumpnl)â€¿"lc rgb 'red' lw 1.5 with lines axes x1y2"
#plt.Plot (ixsâˆ¾Ë˜4âŠ‘Ë˜wodata)â€¿"lw 2 with lines title 'K'"
{pâ€¿xâ†ğ•©â‹„sâ†"lw 2 with lines title '"âˆ¾(â€¢Fmt p)âˆ¾"'"â‹„plt.Plot (ixsâˆ¾Ë˜x)â€¿s}Â¨wks
#plt.Plot (â‰>wixinâ€¿wpin)â€¿"with points pt 9 lw 6 lc rgb '#005500`'"
#plt.Plot (â‰>wixoutâ€¿wpout)â€¿"with points pt 9 lw 6 lc rgb 'red'"
"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"


#################################################
#4â†‘Ë˜wodata
plt â† Gnuplot "
	title 'Linear Kalman Filter' font ',18'
	terminal wxt size 2300,900
	y2tics nomirror tc lt 2
	style line 5 lt rgb 'cyan' lw 5 pt 6"
plt.Plot (ixsâˆ¾Ë˜ 4â†‘Ë˜wodata)â€¿"lw 1 with financebars title 'price'"
plt.Plot (((âŠ‘wixin)â€¿0)âˆ¾wixoutâˆ¾Ë˜wcumpnl)â€¿"lc rgb 'red' lw 1.5 with lines axes x1y2"
{pâ€¿xâ†ğ•©â‹„sâ†"lw 2 with lines title '"âˆ¾(â€¢Fmt p)âˆ¾"'"â‹„plt.Plot (ixsâˆ¾Ë˜x)â€¿s}Â¨wks
plt.Plot (â‰>wixinâ€¿wpin)â€¿"with points pt 9 lw 6 lc rgb '#005500`'"
plt.Plot (â‰>wixoutâ€¿wpout)â€¿"with points pt 9 lw 6 lc rgb 'red'"
"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"





#{ğ•©.Filter 3Ã—â†•5}UKF 1â€¿0.03â€¿0.3â€¿0.2â€¿âŸ¨0.1â€¿2â€¿1âŸ©
#{ğ•©.Pred 1â€¿2}UKF 1â€¿0.3â€¿âŸ¨0.1â€¿2â€¿1âŸ©
###- All in one
#Merwe_Sigmas â† {
#	nâ€¿aâ€¿bâ€¿k â† ğ•¨
#	xâ€¿covâ†ğ•©
#	lâ†((Ã—Ëœa)Ã—(n+k))-n 
#	câ†0.5Ã·n+l
#	wmâ€¿wcâ†(0â€¿(1+b-Ã—Ëœa) + 2â¥ŠlÃ·l+n) âˆ¾Â¨ <wcoâ†(nÃ—2)â¥Šc
#	x ((<âŠ£)(âŠ£âˆ¾+Â¨)âŠ¢)  <Ë˜âˆ¾Â´1â€¿Â¯1Ã—<â‰cholesky.Decompose covÃ—n+l
#} 
#2â€¿0.1â€¿2â€¿1 Merwe_Sigmas âŸ¨3â€¿4,(>âŸ¨1â€¿0,2â€¿1âŸ©)âŸ©

#######################################
### GH-Filter aka Kalman Filter
###
âŸ¨1,0âŸ©â€¿âŸ¨2,4âŸ©
FGHâ†{
	dtâ€¿gâ€¿hâ†ğ•¨
	xpredâ€¿xestâ€¿dx â‡ <Ë˜â‰> (<(2â¥ŠâŠ‘ğ•©)âˆ¾0){
		p_predâ€¿x_estâ€¿dxâ†ğ•¨
		x_predâ†x_est + dxÃ—dt
		residâ†ğ•©-x_pred
		x_predâ€¿(x_pred + gÃ—residÃ·dt)â€¿(dx+hÃ—residÃ·dt)
	}`ğ•© 
} 
#######################################
### Strategy
###
xStra â† {
	XLoad â‡ {â‹†â¼ Â¯2âŠË˜ (âŠ‘ğ•©) LdJson 1â†“ğ•©}
	XIndicatorsâ‡{
		lcâ‡ğ•©
		ghparsâ‡ğ•¨
		xestâ‡(ğ•¨ FGH lc).xest
		abvâ‡lc>xest
		crupâ‡âˆ§âŸœ(Â¬Â»)abv
		crdnâ‡âˆ§âŸœ(Â¬1âŠ¸Â»)Â¬abv
	} 
	XEntries â‡ {
		xindâ‡ğ•©
		#fltâ†0âŠ¸<(âŠ¢-Â») / xind.crup
		#flt â† 0.00 > ((2â¥Š0)âŠ¸Â»-âŠ¢)xind.xest
		xenterâ‡xind.crup
	} 
	#XEntries 1â€¿0.001â€¿0.001 XIndicators "1d" LdJsLc "BTC"
	XExits â‡ {
		xindâ€¿xenterâ‡ğ•©	
		xexitâ‡xind.crdn
	} 
	#xindâ€¿xenterâ€¿xexit â† XExits XEntries 1â€¿0.001â€¿0.001 XIndicators lc
	XPositions â‡ {
		xindâ€¿xenterâ€¿xexitâ‡ğ•©	
		posinxâ‡ /xenter
		poslensâ‡1â†“(((+Â´âˆ˜Â¬âˆ¨`)))Â¨ (+`xenter) âŠ” xexit
		posoutxâ‡ ((â‰ xind.lc)-1)âŒŠposinx+poslens
		cio â‡ (posinxâ‰posoutx) âŠ xind.lc 
		pnlâ‡--Ëcio
		cumpnlâ‡+`pnl
		#winsâ‡
		#winrateâ‡ (()Ã·â‰ ) pnl
	} 
	XStats â‡ {
		pnlâ€¿cumpnlâ‡ğ•©
		statsâ‡{
			retâ‡Â¯1âŠ‘0âˆ¾cumpnl
			ntradesâ‡â‰ pnlâ‹„nwinsâ‡+Â´pnl>0â‹„nlossesâ‡ntrades-nwinsâ‹„winratioâ‡nwinsÃ·ntradesâ‹„
			winsâ‡(0âŠ¸<âŠ¸/)pnlâ‹„lossesâ‡(0âŠ¸â‰¥âŠ¸/)pnlâ‹„avgwinâ‡(+Â´Ã·â‰ )winsâ‹„avglossâ‡(+Â´Ã·â‰ )lossesâ‹„
			maxpnlâ‡âŒˆ`cumpnl
			ddnâ‡-maxpnl-cumpnl
			maxddnâ‡âŒŠÂ´ddn
			volâ‡âˆšVar pnl
			sharpeâ‡retÃ·vol
			toppnlâ‡âŒˆÂ´maxpnl
		}
		#statsâ‡>âŸ¨"#Trades:"â€¿ntrades, "#Wins:"â€¿nwinsâŸ©
		#â€¢Show cumpnl
	}
	XRun â‡ {XStats XPositions XExits XEntries ğ•¨ XIndicators Xload ğ•©}
}

{stâ†ğ•©.statsâ‹„FmtNs ğ•©.statsâ‹„
#	plt â† Gnuplot "
#		title 'Line plot' font ',18'
#		terminal wxt size 1300,600
#		style line 5 lt rgb 'cyan' lw 5 pt 6"
#	plt.Plot (((â†•â‰ )âˆ¾Ë˜âŠ¢)ğ•©.cumpnl)â€¿"lw 1 lc rgb 'black' with lines"
#	plt.Plot (((â†•â‰ )âˆ¾Ë˜âŠ¢)st.maxpnl)â€¿"lw 1 lc rgb 'blue' with lines"
#	plt.Plot (((â†•â‰ )âˆ¾Ë˜âŠ¢)st.ddn)â€¿"lw 1 lc rgb 'blue' with lines"
#	"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
#	â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"
} âŸ¨0.45,0.06138,0.00598âŸ© xStra.XRun "8h"â€¿"ALGO"â€¿"USDT"
#xStra.XStats xStra.XPositions xStra.XExits xStra.XEntriesâŸ¨0.45,0.06138,0.00598âŸ© xStra.XIndicators xStra.Xload "8h"â€¿"ALGO"â€¿"USDT"
#GStra â†{
#	#straâ† XPositions XExits XEntries 1â€¿0.001â€¿0.001 XIndicators lc
#	stra â† ğ•©
#	yminâ€¿ymaxâ† âŒŠâ€¿âŒˆ {ğ• Â´ ğ•©}Â¨<stra.xind.lc
#	tsâ†â†•â‰ stra.xind.lc
#	wsâ€¿wwâ†0â€¿(â‰ stra.xind.lc)
#	â€¢Show stra.xind.ghpars
#	plt â† Gnuplot "
#		title 'G-H Filter:"âˆ¾(â€¢Fmt stra.xind.ghpars)âˆ¾"' font ',18'
#		terminal wxt size 2200,1300
#		y2tics nomirror tc lt 2
#		style line 5 lt rgb 'cyan' lw 5 pt 6
#		style fill empty"
#	#xsâ†plt.Debug @
##	plt.Plot (â‰stra.posinxâ‰âŠstra.cio)â€¿" with lines"
#	plt.Plot (wwâ†‘wsâ†“tsâˆ¾Ë˜stra.xind.lc)â€¿"lw 1 lc rgb 'blue' with lines"
#	plt.Plot (wwâ†‘wsâ†“tsâˆ¾Ë˜stra.xind.xest)â€¿"lw 1.5 with lines"
#	plt.Plot (0â€¿0âˆ¾â‰stra.posoutxâ‰stra.cumpnl)â€¿"lc rgb 'red' lw 1.5 with lines axes x1y2"
#	"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
#	â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"
#	ğ•©
#} 

#GStra XPositions XExits XEntries 1â€¿0.04â€¿0.02 XIndicators (â‹†â¼ Â¯2âŠË˜ "8h"âŠ¸LdJson "BTC"â€¿"USDT") 

##########################################################
### Genetic Algorithm for Parameter Tuning
###########

### Generates random parameters, Floating Point
GenRan â†	<Ë˜âˆ˜â‰âˆ˜>((âŠ£ â€¢rand.Range (2âŠ¸âŠ‘âŠ¢))Ã—((2âŠ¸âŠ‘Ã·ËœâŸœ(1âŠ¸âŠ‘-âŠ‘))âŠ¢))Â¨ 
3 GenRan âŸ¨0,10,100âŸ©â€¿âŸ¨0,1,100âŸ©
### Objective function
{ğ• 2.71} Ã·

### Optimizes Max Drawdown
Objâ† { {ğ•©.stats.toppnl} ğ•© xStra.XRun "8h"â€¿"ALGO"â€¿"USDT" }
#Optimizes PNL
#Objâ† {straâ†XPositions XExits XEntries ğ•© XIndicators (â‹†â¼ Â¯2âŠË˜ "8h"âŠ¸LdJson "LINK"â€¿"USDT") â‹„ Â¯1âŠ‘(0âˆ¾stra.cumpnl)}

#((ObjÂ¨ <Ë˜))
### Calculate Obj on list of params
#>(â‹ˆâŸœObj)Â¨ 5 GenRan âŸ¨0,10,100âŸ©â€¿âŸ¨0,1,100âŸ©â€¿âŸ¨0,1,100âŸ©
### Mutation
Mutate â† {
	râ†1+â€¢rand.Range Â¯1+â‰ âŠ‘ğ•©
	(râ†‘Â¨ğ•©) âˆ¾Â¨ râ†“Â¨(â€¢rand.Deal â‰ ğ•©) âŠ ğ•©
}
Genetic â† {
	pardefs â† ğ•©
	niterâ€¿ntopâ€¿nper â† ğ•¨
	(>(â‹ˆâŸœObj)Â¨ nper GenRan pardefs) {
		ntop â†‘ ((â’1âŠ¸âŠË˜)âŠ¸âŠ) ğ•©âˆ¾ >(â‹ˆâŸœObj)Â¨  (âŠË˜ğ•©) (Â¬âˆ˜âˆŠËœ/âŠ¢) (nper GenRan pardefs)âˆ¾(Mutate âŠË˜ğ•©)
		
	}Â´ â†•niter
 }
{"strat-params.csv" â€¢FLines â€¢FmtÂ¨ <Ë˜ğ•©â‹„ğ•©} 50â€¿20â€¿20 Genetic âŸ¨0,5,10âŸ©â€¿âŸ¨0.0,1,100âŸ©â€¿âŸ¨0.0,1,1000âŸ©
 
3.05â€¿0.05â€¿0.22
0.7â€¿0.01â€¿0.222
2.25â€¿0.01â€¿0.222

#straâ†GStra XPositions XExits XEntries 1â€¿0.03â€¿0.001 XIndicators (â‹†â¼ Â¯2âŠË˜ "4h"âŠ¸LdJson "BTC"â€¿"USDT")
#
#straâ†XPositions XExits XEntries 1â€¿0.02â€¿0.001 XIndicators 500â†‘ lc
#0â€¿0âˆ¾â‰stra.posoutxâ‰stra.cumpnl
#stra.posinx

#############################################
### Parameter sweeping

### Nudge a value by percentage in n steps
Nudge â† {pâ€¿nâ†ğ•¨â‹„ğ•©Ã—1+(pÃ·n)Ã—((â†•1âŠ¸+)+âˆ˜-âŒŠâˆ˜Ã·âŸœ2)n}

dxvâ†2â€¿1000 Nudge 3
gvâ†3â€¿1000 Nudge 0.6
hvâ†0.3â€¿1000 Nudge 0.2
lcâ†(â‹†â¼ Â¯2âŠË˜ "4h"âŠ¸LdJson "BTC"â€¿"USDT")

ppâ†dxvâ‰({ğ•©â€¿0.6â€¿0.2}Â¨ dxv) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ <lc
#ppâ†gvâ‰({3.05â€¿ğ•©â€¿0.227}Â¨ gv) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ <lc
#ppâ†hvâ‰({3.05â€¿0.6â€¿ğ•©}Â¨ hv) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ <lc
plt â† Gnuplot "
	title 'Line plot' font ',18'
	terminal wxt size 1300,600
	style line 5 lt rgb 'cyan' lw 5 pt 6"
plt.Plot (â‰pp)â€¿"lw 1 lc rgb 'blue' with lines"
"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"



#############################################
### Cross-asset pnls

# 1d
#top100â†âŸ¨"AAVE","ADA","ALGO","AMP","APT","ARB","ASTR","ATOM","AVAX","AXS","BCH","BLUR","BNB","BONK","BTC","CAKE","CFX","CHZ","CRV","DOGE","DOT","DYM","EGLD","ENJ","ENS","EOS","ETC","ETH","FIL","FLOW","FTM","GALA","GNO","GRT","HBAR","ICP","ILV","IMX","INJ","IOTA","JUP","KAVA","KLAY","KSM","LDO","LINK","LRC","LTC","LUNA","LUNC","MANA","MANTA","MATIC","MINA","MKR","NEAR","NEO","OP","ORDI","OSMO","PENDLE","PYR","PYTH","QNT","RAY","REN","RNDR","ROSE","RUNE","SAND","SEI","SHIB","SNX","SOL","STX","SUI","THETA","TIA","TRX","UNI","USDC","VET","WOO","XLM","XMR","XRP","XTZ","ZIL"âŸ©
top100â†âŸ¨"AAVE","ADA","ALGO","APT","ARB","ASTR","ATOM","AVAX","AXS","BCH","BLUR","BNB","BONK","BTC","CAKE","CHZ","DOGE","DOT","DYM","EGLD","ENJ","ETC","ETH","FIL","FTM","GALA","GNO","GRT","HBAR","ILV","IMX","INJ","IOTA","JUP","KLAY","KSM","LDO","LINK","LRC","LTC","LUNA","MANA","MANTA","MATIC","MINA","MKR","NEAR","NEO","OP","ORDI","OSMO","PENDLE","PYTH","RNDR","ROSE","RUNE","SAND","SEI","SHIB","SOL","STX","SUI","THETA","TIA","TRX","UNI","USDC","VET","WOO","XLM","XRP","ZIL"âŸ©

#######################################################
### Parameter Sweep over the whole portfolio of top 100
###
#ppâ†(âŠ¢â‰{+Â´1âŠË˜((â‹1âŠ¸âŠË˜)âŠâŠ¢) â‰top100â‰pnlsâ†(<3â€¿ğ•©â€¿0.001) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ (â‹†â¼ Â¯2âŠË˜ "1d"âŠ¸LdJson)Â¨ (top100) â‹ˆÂ¨ <"USDT"}Â¨) 1.5â€¿50 Nudge 0.12
#ppâ†(âŠ¢â‰{+Â´1âŠË˜((â‹1âŠ¸âŠË˜)âŠâŠ¢) â‰top100â‰pnlsâ†(<ğ•©â€¿0.12â€¿0.001) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ (â‹†â¼ Â¯2âŠË˜ "1d"âŠ¸LdJson)Â¨ (top100) â‹ˆÂ¨ <"USDT"}Â¨) 2â€¿50 Nudge 3
#ppâ†(âŠ¢â‰{+Â´1âŠË˜((â‹1âŠ¸âŠË˜)âŠâŠ¢) â‰top100â‰pnlsâ†(<3â€¿0.12â€¿ğ•©) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ (â‹†â¼ Â¯2âŠË˜ "1d"âŠ¸LdJson)Â¨ (top100) â‹ˆÂ¨ <"USDT"}Â¨) 2â€¿100 Nudge  0.001

#plt â† Gnuplot "
#	title 'Line plot' font ',18'
#	terminal wxt size 1300,600
#	style line 5 lt rgb 'cyan' lw 5 pt 6"
#plt.Plot (â‰pp)â€¿"lw 1 lc rgb 'blue' with lines"
#"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
#â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"

#######################################################



apnlsâ†((â‹1âŠ¸âŠË˜)âŠâŠ¢) â‰top100â‰pnls
+Â´1âŠË˜apnls
3â†‘klinesâ† "1d" LdJson "XRP"â€¿"USDT"
3â†‘ lohlcâ† â‹†â¼ 1â†“Ë˜ Â¯1â†“Ë˜ klines 
lcâ†Â¯1âŠË˜lohlc









#################################################################
### Directional Change / ZigZag Algorithm 
#################################################################
IfElse â† {condâ€¿Trueâ€¿False: condâ—¶Falseâ€¿True @}
TestConds â† {fnâ†{Condâ€¿Act ğ•Š else: Condâ—¶Elseâ€¿Act}Â´ğ•© â‹„ Fn@}
clâ† â‹†â¼ Â¯2âŠ¸âŠË˜ "BTC"â€¿"USDT" LoadCandles "1d"
Peaks â† {
	qdcâ†ğ•¨â‹„
	âŒ½Â¯1âŠ‘(0â€¿1â€¿0â€¿(âŠ‘ğ•©)â€¿(â‰0â€¿0)) {
		ixâ€¿dirâ€¿xiâ€¿xpâ€¿evxâ†ğ•©
		pâ†ğ•¨
		naccâ† TestConds âŸ¨
			(0<dirÃ—p-xp)â€¿		{ğ•¤â‹„dirâ€¿ixâ€¿pâ€¿evx}		# Continues in the same direction as before, update xi & xp
			{qdcâ‰¥dirÃ—-p-xp}â€¿	{ğ•¤â‹„dirâ€¿xiâ€¿xpâ€¿evx}		# Opposite direction, below threshold, keep previous xi & xp
											{ğ•¤â‹„(-dir)â€¿ixâ€¿pâ€¿((xiâ€¿dir)âˆ¾evx)} # Opposite direction, above threshold, change direction
		âŸ©
		(ix+1)âˆ¾nacc
	}Â´ âŒ½ğ•©â‹„
}
pks â† 0.20 Peaks cl 
pixâ†0âŠ‘Ë˜pks
pcpixâ†pixâŠ¸âŠcl
0.15>|-Ëpcpixâ‰Â»pcpix
ixsâ†â†•â‰ cl
plt â† Gnuplot "
	title 'ZigZag Algorithm' font ',18'
	terminal wxt size 1800,900
	style line 1 lt rgb 'black' lw 1"
plt.Plot (â‰>pixâ€¿pcpix)â€¿" lw 2 lc rgb 'red' pt 7 ps 3"
plt.Plot (â‰>ixsâ€¿cl)â€¿"lw 1 lc rgb 'black' with lines"
"gnuplot-zigzag-1.txt" â€¢file.Chars plt.Debug @
â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-zigzag-1.txt"
18541.28 Ã· 18325.11 -1 






stds â† 14 WStd cl
ixsâ†(â†•â‰ cl)
â‰>ixsâ€¿cl
emaBo â† 21 Ema cl
boLâ€¿boH â† (<emaBo) +Ë˜ âŸ¨Â¯1,1âŸ©Ã—Â¨<stds
#â‰ bol
cl
#â‰>ixsâ€¿emaBo

plt â† Gnuplot "
  title 'Price and EMA' font ',18'
	terminal wxt size 1300,600
	style line 5 lt rgb 'cyan' lw 3 pt 6
"
4â†‘â‰>ixsâ€¿cl
plt.Plot (â‰>ixsâ€¿cl)â€¿"lw 0.5 lc rgb 'blue' with lines"
plt.Plot (â‰>ixsâ€¿emaBo)â€¿"lw 0.5 lc rgb 'black' with lines"
plt.Plot (â‰>ixsâ€¿boL)â€¿"lw 0.5 lc rgb 'green' with lines"
plt.Plot (â‰>ixsâ€¿boH)â€¿"lw 0.5 lc rgb 'red' with lines"
# ZigZag like neurotrader


"gnuplot-example-1.txt" â€¢file.Chars plt.Debug @

0.1 {ğ•©} cl



#âŸ¨4â€¿4,0â€¿âˆâŸ© âŠ‘ dcv


#hwâ†"h"
#hwâ†©"Hello "â€¿"World!"
#â¥ŠÂ¨hw
 
