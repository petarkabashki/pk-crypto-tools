
âŸ¨GnuplotâŸ© â† â€¢Import "Gnuplot.bqn"

âŸ¨JParseâ‡Parse,JExportâ‡ExportâŸ©â†â€¢Import "bqn-libs/json.bqn"
âŸ¨Split , Join,  SplitL, JoinLâŸ©â†â€¢Import "bqn-libs/csv.bqn"
âŸ¨GLine, WMean, Ema, Var, WVar, WStd, GBars, CumBins, CumBinsPct, HBins, Hist, PHistâŸ©â†â€¢Import "pk-libs.bqn"

csv â† "',/" â€¢Import "./bqn-libs/csv.bqn"  # Easier characters to write
csvdir â† "/media/grenada/Data/Crypto-Historical-Data/data-csv/binance/"

LdCsv â† { 
	baseâ€¿quoteâ†ğ•¨â‹„
	timeframeâ†ğ•©â‹„
	>â€¢ParseFloatÂ¨Â¨ 1â†“ csv.SplitL â€¢FLines csvdir âˆ¾baseâˆ¾"_"âˆ¾quoteâˆ¾"-"âˆ¾timeframeâˆ¾".csv"â‹„
}
#10â†‘âŸ¨"BTC","USDT"âŸ© LoadCandles "1d"

jsondirâ†"/media/grenada/Data/Crypto-Data-Feed/freq-user-data/data/binance/"
LdJson â†{ 
	>JParse â€¢FChars jsondirâˆ¾(âŠ‘ğ•©)âˆ¾"_"âˆ¾(1âŠ‘ğ•©)âˆ¾"-"âˆ¾(ğ•¨)âˆ¾".json"
}
LdJsLc â† {â‹†â¼ Â¯2âŠË˜ ğ•¨ LdJson ğ•©â€¿"USDT"}
errmeaâ†0.1
### GH-Filter aka Kalman Filter
FGHâ†{
	dtâ€¿gâ€¿hâ†ğ•¨
	xpredâ€¿xestâ€¿dx â‡ <Ë˜â‰> (<(2â¥ŠâŠ‘ğ•©)âˆ¾0){
		p_predâ€¿x_estâ€¿dxâ†ğ•¨
		x_predâ†x_est + dxÃ—dt
		residâ†ğ•©-x_pred
		x_predâ€¿(x_pred + gÃ—residÃ·dt)â€¿(dx+hÃ—residÃ·dt)
	}`ğ•© 
} 
#######################################
### Strategy
###
xStra â† {
	XLoad â‡ {â‹†â¼ Â¯2âŠË˜ (âŠ‘ğ•©) LdJson 1â†“ğ•©}
	XIndicatorsâ‡{
		lcâ‡ğ•©
		ghparsâ‡ğ•¨
		xestâ‡(ğ•¨ FGH lc).xest
		abvâ‡lc>xest
		crupâ‡âˆ§âŸœ(Â¬Â»)abv
		crdnâ‡âˆ§âŸœ(Â¬1âŠ¸Â»)Â¬abv
	} 
	XEntries â‡ {
		xindâ‡ğ•©
		#fltâ†0âŠ¸<(âŠ¢-Â») / xind.crup
		#flt â† 0.00 > ((2â¥Š0)âŠ¸Â»-âŠ¢)xind.xest
		xenterâ‡xind.crup
	} 
	#XEntries 1â€¿0.001â€¿0.001 XIndicators "1d" LdJsLc "BTC"
	XExits â‡ {
		xindâ€¿xenterâ‡ğ•©	
		xexitâ‡xind.crdn
	} 
	#xindâ€¿xenterâ€¿xexit â† XExits XEntries 1â€¿0.001â€¿0.001 XIndicators lc
	XPositions â‡ {
		xindâ€¿xenterâ€¿xexitâ‡ğ•©	
		posinxâ‡ /xenter
		poslensâ‡1â†“(((+Â´âˆ˜Â¬âˆ¨`)))Â¨ (+`xenter) âŠ” xexit
		posoutxâ‡ ((â‰ xind.lc)-1)âŒŠposinx+poslens
		cio â‡ (posinxâ‰posoutx) âŠ xind.lc 
		pnlâ‡--Ëcio
		cumpnlâ‡+`pnl
		#winsâ‡
		#winrateâ‡ (()Ã·â‰ ) pnl
	} 
	XStats â‡ {
		pnlâ€¿cumpnlâ‡ğ•©
		statsâ‡{
			retâ‡Â¯1âŠ‘0âˆ¾cumpnl
			ntradesâ‡â‰ pnlâ‹„nwinsâ‡+Â´pnl>0â‹„nlossesâ‡ntrades-nwinsâ‹„winratioâ‡nwinsÃ·ntradesâ‹„
			winsâ‡(0âŠ¸<âŠ¸/)pnlâ‹„lossesâ‡(0âŠ¸â‰¥âŠ¸/)pnlâ‹„avgwinâ‡(+Â´Ã·â‰ )winsâ‹„avglossâ‡(+Â´Ã·â‰ )lossesâ‹„
			maxpnlâ‡âŒˆ`cumpnl
			ddnâ‡-maxpnl-cumpnl
			maxddnâ‡âŒŠÂ´ddn
			volâ‡âˆšVar pnl
			sharpeâ‡retÃ·vol
			toppnlâ‡âŒˆÂ´maxpnl
		}
		#statsâ‡>âŸ¨"#Trades:"â€¿ntrades, "#Wins:"â€¿nwinsâŸ©
		#â€¢Show cumpnl
	}
	XRun â‡ {XStats XPositions XExits XEntries ğ•¨ XIndicators Xload ğ•©}
}
FmtNs â† {kâ†â€¢ns.Keys ğ•©â‹„â‰kâ‰ğ•© â€¢ns.GetÂ¨k}

{stâ†ğ•©.statsâ‹„â€¢Show FmtNs stâ‹„
	plt â† Gnuplot "
		title 'Line plot' font ',18'
		terminal wxt size 1300,600
		style line 5 lt rgb 'cyan' lw 5 pt 6"
	plt.Plot (((â†•â‰ )âˆ¾Ë˜âŠ¢)ğ•©.cumpnl)â€¿"lw 1 lc rgb 'blue' with lines"
	"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
	â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"
} âŸ¨0.45,0.06138,0.00598âŸ© xStra.XRun "8h"â€¿"ALGO"â€¿"USDT"
#xStra.XStats xStra.XPositions xStra.XExits xStra.XEntriesâŸ¨0.45,0.06138,0.00598âŸ© xStra.XIndicators xStra.Xload "8h"â€¿"ALGO"â€¿"USDT"
GStra â†{
	#straâ† XPositions XExits XEntries 1â€¿0.001â€¿0.001 XIndicators lc
	stra â† ğ•©
	yminâ€¿ymaxâ† âŒŠâ€¿âŒˆ {ğ• Â´ ğ•©}Â¨<stra.xind.lc
	tsâ†â†•â‰ stra.xind.lc
	wsâ€¿wwâ†0â€¿(â‰ stra.xind.lc)
	â€¢Show stra.xind.ghpars
	plt â† Gnuplot "
		title 'G-H Filter:"âˆ¾(â€¢Fmt stra.xind.ghpars)âˆ¾"' font ',18'
		terminal wxt size 2200,1300
		y2tics nomirror tc lt 2
		style line 5 lt rgb 'cyan' lw 5 pt 6
		style fill empty"
	#xsâ†plt.Debug @
#	plt.Plot (â‰stra.posinxâ‰âŠstra.cio)â€¿" with lines"
	plt.Plot (wwâ†‘wsâ†“tsâˆ¾Ë˜stra.xind.lc)â€¿"lw 1 lc rgb 'blue' with lines"
	plt.Plot (wwâ†‘wsâ†“tsâˆ¾Ë˜stra.xind.xest)â€¿"lw 1.5 with lines"
	plt.Plot (0â€¿0âˆ¾â‰stra.posoutxâ‰stra.cumpnl)â€¿"lc rgb 'red' lw 1.5 with lines axes x1y2"
	"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
	â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"
	ğ•©
} 

#GStra XPositions XExits XEntries 1â€¿0.04â€¿0.02 XIndicators (â‹†â¼ Â¯2âŠË˜ "8h"âŠ¸LdJson "BTC"â€¿"USDT") 

##########################################################
### Genetic Algorithm for Parameter Tuning
###########

### Generates random parameters 
GenRan â†	<Ë˜âˆ˜â‰âˆ˜>((âŠ£ â€¢rand.Range (2âŠ¸âŠ‘âŠ¢))Ã—((2âŠ¸âŠ‘Ã·ËœâŸœ(1âŠ¸âŠ‘-âŠ‘))âŠ¢))Â¨ 
3 GenRan âŸ¨0,10,100âŸ©â€¿âŸ¨0,1,100âŸ©
### Objective function
Objâ† {straâ†XPositions XExits XEntries ğ•© XIndicators (â‹†â¼ Â¯2âŠË˜ "8h"âŠ¸LdJson "EGLD"â€¿"USDT") â‹„ Â¯1âŠ‘(0âˆ¾stra.cumpnl)}
#((ObjÂ¨ <Ë˜))
### Calculate Obj on list of params
#>(â‹ˆâŸœObj)Â¨ 5 GenRan âŸ¨0,10,100âŸ©â€¿âŸ¨0,1,100âŸ©â€¿âŸ¨0,1,100âŸ©
### Mutation
Mutate â† {
	râ†1+â€¢rand.Range Â¯1+â‰ âŠ‘ğ•©
	(râ†‘Â¨ğ•©) âˆ¾Â¨ râ†“Â¨(â€¢rand.Deal â‰ ğ•©) âŠ ğ•©
}
Genetic â† {
	pardefs â† ğ•©
	niterâ€¿ntopâ€¿nperâ€¿nmut â† ğ•¨
	(>(â‹ˆâŸœObj)Â¨ nper GenRan pardefs) {
		ntop â†‘ ((â’Â¯1âŠ¸âŠË˜)âŠ¸âŠ) ğ•©âˆ¾ >(â‹ˆâŸœObj)Â¨  (âŠË˜ğ•©) (Â¬âˆ˜âˆŠËœ/âŠ¢) (nper GenRan pardefs)âˆ¾(Mutate âŠË˜ğ•©)
		
	}Â´ â†•niter
 }
{"strat-params.csv" â€¢FLines â€¢FmtÂ¨ <Ë˜ğ•©â‹„ğ•©} 10â€¿20â€¿10â€¿10 Genetic âŸ¨1,4,20âŸ©â€¿âŸ¨0.001,0.1,100âŸ©â€¿âŸ¨0.001,0.3,100âŸ©
 
3.05â€¿0.05â€¿0.22
0.7â€¿0.01â€¿0.222
2.25â€¿0.01â€¿0.222

#straâ†GStra XPositions XExits XEntries 1â€¿0.03â€¿0.001 XIndicators (â‹†â¼ Â¯2âŠË˜ "4h"âŠ¸LdJson "BTC"â€¿"USDT")
#
#straâ†XPositions XExits XEntries 1â€¿0.02â€¿0.001 XIndicators 500â†‘ lc
#0â€¿0âˆ¾â‰stra.posoutxâ‰stra.cumpnl
#stra.posinx

#############################################
### Parameter sweeping

### Nudge a value by percentage in n steps
Nudge â† {pâ€¿nâ†ğ•¨â‹„ğ•©Ã—1+(pÃ·n)Ã—((â†•1âŠ¸+)+âˆ˜-âŒŠâˆ˜Ã·âŸœ2)n}

dxvâ†2â€¿1000 Nudge 3
gvâ†3â€¿1000 Nudge 0.6
hvâ†0.3â€¿1000 Nudge 0.2
lcâ†(â‹†â¼ Â¯2âŠË˜ "4h"âŠ¸LdJson "BTC"â€¿"USDT")

ppâ†dxvâ‰({ğ•©â€¿0.6â€¿0.2}Â¨ dxv) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ <lc
#ppâ†gvâ‰({3.05â€¿ğ•©â€¿0.227}Â¨ gv) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ <lc
#ppâ†hvâ‰({3.05â€¿0.6â€¿ğ•©}Â¨ hv) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ <lc
plt â† Gnuplot "
	title 'Line plot' font ',18'
	terminal wxt size 1300,600
	style line 5 lt rgb 'cyan' lw 5 pt 6"
plt.Plot (â‰pp)â€¿"lw 1 lc rgb 'blue' with lines"
"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"



#############################################
### Cross-asset pnls

# 1d
#top100â†âŸ¨"AAVE","ADA","ALGO","AMP","APT","ARB","ASTR","ATOM","AVAX","AXS","BCH","BLUR","BNB","BONK","BTC","CAKE","CFX","CHZ","CRV","DOGE","DOT","DYM","EGLD","ENJ","ENS","EOS","ETC","ETH","FIL","FLOW","FTM","GALA","GNO","GRT","HBAR","ICP","ILV","IMX","INJ","IOTA","JUP","KAVA","KLAY","KSM","LDO","LINK","LRC","LTC","LUNA","LUNC","MANA","MANTA","MATIC","MINA","MKR","NEAR","NEO","OP","ORDI","OSMO","PENDLE","PYR","PYTH","QNT","RAY","REN","RNDR","ROSE","RUNE","SAND","SEI","SHIB","SNX","SOL","STX","SUI","THETA","TIA","TRX","UNI","USDC","VET","WOO","XLM","XMR","XRP","XTZ","ZIL"âŸ©
top100â†âŸ¨"AAVE","ADA","ALGO","APT","ARB","ASTR","ATOM","AVAX","AXS","BCH","BLUR","BNB","BONK","BTC","CAKE","CHZ","DOGE","DOT","DYM","EGLD","ENJ","ETC","ETH","FIL","FTM","GALA","GNO","GRT","HBAR","ILV","IMX","INJ","IOTA","JUP","KLAY","KSM","LDO","LINK","LRC","LTC","LUNA","MANA","MANTA","MATIC","MINA","MKR","NEAR","NEO","OP","ORDI","OSMO","PENDLE","PYTH","RNDR","ROSE","RUNE","SAND","SEI","SHIB","SOL","STX","SUI","THETA","TIA","TRX","UNI","USDC","VET","WOO","XLM","XRP","ZIL"âŸ©

#######################################################
### Parameter Sweep over the whole portfolio of top 100
###
#ppâ†(âŠ¢â‰{+Â´1âŠË˜((â‹1âŠ¸âŠË˜)âŠâŠ¢) â‰top100â‰pnlsâ†(<3â€¿ğ•©â€¿0.001) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ (â‹†â¼ Â¯2âŠË˜ "1d"âŠ¸LdJson)Â¨ (top100) â‹ˆÂ¨ <"USDT"}Â¨) 1.5â€¿50 Nudge 0.12
#ppâ†(âŠ¢â‰{+Â´1âŠË˜((â‹1âŠ¸âŠË˜)âŠâŠ¢) â‰top100â‰pnlsâ†(<ğ•©â€¿0.12â€¿0.001) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ (â‹†â¼ Â¯2âŠË˜ "1d"âŠ¸LdJson)Â¨ (top100) â‹ˆÂ¨ <"USDT"}Â¨) 2â€¿50 Nudge 3
#ppâ†(âŠ¢â‰{+Â´1âŠË˜((â‹1âŠ¸âŠË˜)âŠâŠ¢) â‰top100â‰pnlsâ†(<3â€¿0.12â€¿ğ•©) { Â¯1âŠ‘0âˆ¾(XPositions XExits XEntries ğ•¨ XIndicators ğ•©).cumpnl}Â¨ (â‹†â¼ Â¯2âŠË˜ "1d"âŠ¸LdJson)Â¨ (top100) â‹ˆÂ¨ <"USDT"}Â¨) 2â€¿100 Nudge  0.001

#plt â† Gnuplot "
#	title 'Line plot' font ',18'
#	terminal wxt size 1300,600
#	style line 5 lt rgb 'cyan' lw 5 pt 6"
#plt.Plot (â‰pp)â€¿"lw 1 lc rgb 'blue' with lines"
#"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
#â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"

#######################################################



apnlsâ†((â‹1âŠ¸âŠË˜)âŠâŠ¢) â‰top100â‰pnls
+Â´1âŠË˜apnls
3â†‘klinesâ† "1d" LdJson "XRP"â€¿"USDT"
3â†‘ lohlcâ† â‹†â¼ 1â†“Ë˜ Â¯1â†“Ë˜ klines 
lcâ†Â¯1âŠË˜lohlc













#################################################################
### Ichimoku Cloud 
#################################################################
Ichimoku â† {
	conâ€¿banâ€¿bnâ†ğ•¨â‹„
	col â† Ã·âŸœ2 +Â´âŒˆâ€¿âŒŠ {(0â¥ŠËœcon-1)âˆ¾ğ• ËË˜ conâ†•ğ•©}Â¨ â‹ˆËâ‰2â€¿3âŠ¸âŠË˜ğ•©â‹„
	bal â† Ã·âŸœ2 +Â´âŒˆâ€¿âŒŠ {(0â¥ŠËœban-1)âˆ¾ğ• ËË˜ banâ†•ğ•©}Â¨ â‹ˆËâ‰2â€¿3âŠ¸âŠË˜ğ•©â‹„
	lesA â† (banâ¥Š0)Â» Ã·âŸœ2 col + balâ‹„
	lesB â† (banâ¥Š0)Â» Ã·âŸœ2 +Â´âŒˆâ€¿âŒŠ {(0â¥ŠËœbn-1)âˆ¾ğ• ËË˜ bnâ†•ğ•©}Â¨ â‹ˆËâ‰2â€¿3âŠ¸âŠË˜ğ•©â‹„
	colâ€¿balâ€¿lesAâ€¿lesB
}

PlotIchimoku â† {
	baseâ€¿quoteâ†ğ•¨â‹„
	timeframeâ†ğ•©â‹„
	
	dcv â†500â†‘baseâ€¿quote LoadCandles timeframeâ‹„
	clâ†Â¯2âŠË˜dcvâ‹„
	colâ€¿balâ€¿lesAâ€¿lesB â† 30â€¿60â€¿120 Ichimoku dcvâ‹„
	ixs â† â†•â‰ dcvâ‹„
	plt â† Gnuplot "
		title 'Ichimoku Cloud' font ',18'
		terminal wxt size 1800,900
		style line 5 lt rgb 'cyan' lw 3 pt 6"
	plt.Plot (â‰>ixsâ€¿lesAâ€¿lesB)â€¿" with filledcurves fs solid 0.1"
	plt.Plot (â‰>ixsâ€¿cl)â€¿"lw 1 lc rgb 'black' with lines"
	plt.Plot (â‰>ixsâ€¿col)â€¿"lw 1 lc rgb '#5555CC' with lines"
	plt.Plot (â‰>ixsâ€¿bal)â€¿"lw 1 lc rgb 'red' with lines"
	plt.Plot (â‰>ixsâ€¿lesA)â€¿"lw 1 lc rgb 'gray' with lines"
	plt.Plot (â‰>ixsâ€¿lesB)â€¿"lw 1 lc rgb 'gray' with lines"
	"gnuplot-ichimoku-1.txt" â€¢file.Chars plt.Debug @
	â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-ichimoku-1.txt"
}
#"BTC"â€¿"USDT" PlotIchimoku "1d"
###

#################################################################
### Directional Change / ZigZag Algorithm 
#################################################################
IfElse â† {condâ€¿Trueâ€¿False: condâ—¶Falseâ€¿True @}
TestConds â† {fnâ†{Condâ€¿Act ğ•Š else: Condâ—¶Elseâ€¿Act}Â´ğ•© â‹„ Fn@}
clâ† â‹†â¼ Â¯2âŠ¸âŠË˜ "BTC"â€¿"USDT" LoadCandles "1d"
Peaks â† {
	qdcâ†ğ•¨â‹„
	âŒ½Â¯1âŠ‘(0â€¿1â€¿0â€¿(âŠ‘ğ•©)â€¿(â‰0â€¿0)) {
		ixâ€¿dirâ€¿xiâ€¿xpâ€¿evxâ†ğ•©
		pâ†ğ•¨
		naccâ† TestConds âŸ¨
			(0<dirÃ—p-xp)â€¿		{ğ•¤â‹„dirâ€¿ixâ€¿pâ€¿evx}		# Continues in the same direction as before, update xi & xp
			{qdcâ‰¥dirÃ—-p-xp}â€¿	{ğ•¤â‹„dirâ€¿xiâ€¿xpâ€¿evx}		# Opposite direction, below threshold, keep previous xi & xp
											{ğ•¤â‹„(-dir)â€¿ixâ€¿pâ€¿((xiâ€¿dir)âˆ¾evx)} # Opposite direction, above threshold, change direction
		âŸ©
		(ix+1)âˆ¾nacc
	}Â´ âŒ½ğ•©â‹„
}
pks â† 0.20 Peaks cl 
pixâ†0âŠ‘Ë˜pks
pcpixâ†pixâŠ¸âŠcl
0.15>|-Ëpcpixâ‰Â»pcpix
ixsâ†â†•â‰ cl
plt â† Gnuplot "
	title 'ZigZag Algorithm' font ',18'
	terminal wxt size 1800,900
	style line 1 lt rgb 'black' lw 1"
plt.Plot (â‰>pixâ€¿pcpix)â€¿" lw 2 lc rgb 'red' pt 7 ps 3"
plt.Plot (â‰>ixsâ€¿cl)â€¿"lw 1 lc rgb 'black' with lines"
"gnuplot-zigzag-1.txt" â€¢file.Chars plt.Debug @
â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-zigzag-1.txt"
18541.28 Ã· 18325.11 -1 






stds â† 14 WStd cl
ixsâ†(â†•â‰ cl)
â‰>ixsâ€¿cl
emaBo â† 21 Ema cl
boLâ€¿boH â† (<emaBo) +Ë˜ âŸ¨Â¯1,1âŸ©Ã—Â¨<stds
#â‰ bol
cl
#â‰>ixsâ€¿emaBo

plt â† Gnuplot "
  title 'Price and EMA' font ',18'
	terminal wxt size 1300,600
	style line 5 lt rgb 'cyan' lw 3 pt 6
"
4â†‘â‰>ixsâ€¿cl
plt.Plot (â‰>ixsâ€¿cl)â€¿"lw 0.5 lc rgb 'blue' with lines"
plt.Plot (â‰>ixsâ€¿emaBo)â€¿"lw 0.5 lc rgb 'black' with lines"
plt.Plot (â‰>ixsâ€¿boL)â€¿"lw 0.5 lc rgb 'green' with lines"
plt.Plot (â‰>ixsâ€¿boH)â€¿"lw 0.5 lc rgb 'red' with lines"
# ZigZag like neurotrader


"gnuplot-example-1.txt" â€¢file.Chars plt.Debug @

0.1 {ğ•©} cl



#âŸ¨4â€¿4,0â€¿âˆâŸ© âŠ‘ dcv


#hwâ†"h"
#hwâ†©"Hello "â€¿"World!"
#â¥ŠÂ¨hw
 
