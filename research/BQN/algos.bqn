
âŸ¨GnuplotâŸ© â† â€¢Import "Gnuplot.bqn"

âŸ¨JParseâ‡ParseâŸ©â†â€¢Import "bqn-libs/json.bqn"
âŸ¨WMean, Ema, Var, WVar, WStd, GBars, CumBins, CumBinsPct, HBins, Hist, PHistâŸ©â†â€¢Import "pk-libs.bqn"

csv â† "',/" â€¢Import "./bqn-libs/csv.bqn"  # Easier characters to write
csvdir â† "/media/grenada/Data/Crypto-Historical-Data/data-csv/binance/"

LdCsv â† { 
	baseâ€¿quoteâ†ğ•¨â‹„
	timeframeâ†ğ•©â‹„
	>â€¢ParseFloatÂ¨Â¨ 1â†“ csv.SplitL â€¢FLines csvdir âˆ¾baseâˆ¾"_"âˆ¾quoteâˆ¾"-"âˆ¾timeframeâˆ¾".csv"â‹„
}
#10â†‘âŸ¨"BTC","USDT"âŸ© LoadCandles "1d"

jsondirâ†"/media/grenada/Data/Crypto-Data-Feed/freq-user-data/data/binance/"
LdJson â†{ 
	>JParse â€¢FChars jsondirâˆ¾(âŠ‘ğ•©)âˆ¾"_"âˆ¾(1âŠ‘ğ•©)âˆ¾"-"âˆ¾(ğ•¨)âˆ¾".json"
}

#################################################################
### Calman Filter 
###############################################################
3â†‘tklsâ† "8h" LdJson "AVAX"â€¿"USDT"
3â†‘ lclâ† â‹†â¼ 1â†“Ë˜ Â¯1â†“Ë˜ tkls
clâ†Â¯1âŠË˜lcl
errmeaâ†0.1
### GH-Filter aka Kalman Filter
GHFâ†{
	dtâ€¿gâ€¿hâ†ğ•¨
	(<(2â¥ŠâŠ‘cl)âˆ¾0){
		zâ†ğ•©
		p_predâ€¿x_estâ€¿dxâ†ğ•¨
		# prediction step
		x_predâ†x_est + dxÃ—dt
		# update step
		residâ†z-x_pred
		x_predâ€¿(x_pred + gÃ—residÃ·dt)â€¿(dx+hÃ—residÃ·dt)
	} ` ğ•© 
} 
XPos â† {
	clâ€¿klmâ†ğ•©â‹„abvâ†cl>klmâ‹„crupâ†âˆ§âŸœ(Â¬Â»)abvâ‹„crdnâ†âˆ§âŸœ(Â¬1âŠ¸Â»)Â¬abvâ‹„
	ixposâ†crup (>âˆ˜{mâ†âŒŠÂ´â‰ Â¨ğ•©â‹„mâ†‘Â¨ğ•©}âˆ˜â‹ˆâ—‹/) crdn
	clposâ†ixpos âŠ cl
	drâ† 0>  -Ë(âŠ¢âŠâŸœklm) (âŠ¢â‰-âŸœ2) (âŠixpos)	
	pnl â† drÃ— --Ë clpos
	cumpnl â† +`pnl
	pnlâ‰cumpnl
	ixposâ€¿clposâ€¿(pnlâ‰cumpnl)
}
#wixposâ†sksâ†“Ë˜skeâ†“Ë˜ixpos â‹„ wclposâ†sksâ†“Ë˜skeâ†“Ë˜clposâ‹„ wpnlsâ†sksâ†“Ë˜skeâ†“Ë˜pnls
GLineâ† {
	wsâ€¿wwâ†ğ•¨
	plt â† Gnuplot "
		title 'Line plot' font ',18'
		terminal wxt size 1300,600
		style line 5 lt rgb 'cyan' lw 5 pt 6"
	plt.Plot (wwâ†‘wsâ†“((â†•â‰ )âˆ¾Ë˜âŠ¢)ğ•©)â€¿"lw 1 lc rgb 'blue' with lines"
	"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
	â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"
}
Btest â† {
	ghparsâ€¿wswâ†ğ•¨â‹„wsâ€¿wwâ†wswâ‹„clâ†ğ•©â‹„
	klmâ†> (1âŠ¸âŠË˜>)Â¨  (<ghpars) (GHF)Â¨ <cl
	ixposâ€¿clposâ€¿pnls â† XPos clâ€¿klm
	tsâ†â†•â‰ tkls
	sksâ€¿skeâ† wsâ€¿ww{wsâ€¿wwâ†ğ•¨â‹„((-+Â´(ws+ww)<1âŠ¸âŠğ•©))â€¿(+Â´ws>âŠğ•©)} ixpos
	wixposâ€¿wclposâ€¿wpnlsâ†(skeâŠ¸â†“Ë˜ sksâŠ¸â†“Ë˜)Â¨ixposâ€¿clposâ€¿pnls
	plt â† Gnuplot "
		title 'G-H Filter' font ',18'
		terminal wxt size 1300,600
		y2tics nomirror tc lt 2
		style line 5 lt rgb 'cyan' lw 5 pt 6
		style fill empty"
	xsâ†plt.Debug @
	plt.Plot (wwâ†‘wsâ†“tsâˆ¾Ë˜cl)â€¿"lw 1 lc rgb 'blue' with lines"
	plt.Plot (wwâ†‘wsâ†“tsâˆ¾Ë˜klm)â€¿"lw 1.5 with lines"
	plt.Plot (â‰>Â¯1âŠ¸âŠÂ¨wixposâ€¿wpnls)â€¿"lc rgb 'red' lw 1.5 with lines axes x1y2"
	"gnuplot-tmp-1.txt"â€¢file.Chars plt.Debug @
	â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-tmp-1.txt"
	klmâ€¿ixposâ€¿clposâ€¿pnlsâ€¿wixposâ€¿wclposâ€¿wpnls
} 

klmâ€¿ixposâ€¿clposâ€¿pnlsâ€¿wixposâ€¿wclposâ€¿wpnlsâ†(0.001â€¿0.00001â€¿0.000007)â€¿(0â€¿(â‰ cl))  Btest cl
Â¯10â†‘Â¨wpnls
ys2tics 20 nomirror tc lt 2

















#################################################################
### Ichimoku Cloud 
#################################################################
Ichimoku â† {
	conâ€¿banâ€¿bnâ†ğ•¨â‹„
	col â† Ã·âŸœ2 +Â´âŒˆâ€¿âŒŠ {(0â¥ŠËœcon-1)âˆ¾ğ• ËË˜ conâ†•ğ•©}Â¨ â‹ˆËâ‰2â€¿3âŠ¸âŠË˜ğ•©â‹„
	bal â† Ã·âŸœ2 +Â´âŒˆâ€¿âŒŠ {(0â¥ŠËœban-1)âˆ¾ğ• ËË˜ banâ†•ğ•©}Â¨ â‹ˆËâ‰2â€¿3âŠ¸âŠË˜ğ•©â‹„
	lesA â† (banâ¥Š0)Â» Ã·âŸœ2 col + balâ‹„
	lesB â† (banâ¥Š0)Â» Ã·âŸœ2 +Â´âŒˆâ€¿âŒŠ {(0â¥ŠËœbn-1)âˆ¾ğ• ËË˜ bnâ†•ğ•©}Â¨ â‹ˆËâ‰2â€¿3âŠ¸âŠË˜ğ•©â‹„
	colâ€¿balâ€¿lesAâ€¿lesB
}

PlotIchimoku â† {
	baseâ€¿quoteâ†ğ•¨â‹„
	timeframeâ†ğ•©â‹„
	
	dcv â†500â†‘baseâ€¿quote LoadCandles timeframeâ‹„
	clâ†Â¯2âŠË˜dcvâ‹„
	colâ€¿balâ€¿lesAâ€¿lesB â† 30â€¿60â€¿120 Ichimoku dcvâ‹„
	ixs â† â†•â‰ dcvâ‹„
	plt â† Gnuplot "
		title 'Ichimoku Cloud' font ',18'
		terminal wxt size 1800,900
		style line 5 lt rgb 'cyan' lw 3 pt 6"
	plt.Plot (â‰>ixsâ€¿lesAâ€¿lesB)â€¿" with filledcurves fs solid 0.1"
	plt.Plot (â‰>ixsâ€¿cl)â€¿"lw 1 lc rgb 'black' with lines"
	plt.Plot (â‰>ixsâ€¿col)â€¿"lw 1 lc rgb '#5555CC' with lines"
	plt.Plot (â‰>ixsâ€¿bal)â€¿"lw 1 lc rgb 'red' with lines"
	plt.Plot (â‰>ixsâ€¿lesA)â€¿"lw 1 lc rgb 'gray' with lines"
	plt.Plot (â‰>ixsâ€¿lesB)â€¿"lw 1 lc rgb 'gray' with lines"
	"gnuplot-ichimoku-1.txt" â€¢file.Chars plt.Debug @
	â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-ichimoku-1.txt"
}
#"BTC"â€¿"USDT" PlotIchimoku "1d"
###

#################################################################
### Directional Change / ZigZag Algorithm 
#################################################################
IfElse â† {condâ€¿Trueâ€¿False: condâ—¶Falseâ€¿True @}
TestConds â† {fnâ†{Condâ€¿Act ğ•Š else: Condâ—¶Elseâ€¿Act}Â´ğ•© â‹„ Fn@}
clâ† â‹†â¼ Â¯2âŠ¸âŠË˜ "BTC"â€¿"USDT" LoadCandles "1d"
Peaks â† {
	qdcâ†ğ•¨â‹„
	âŒ½Â¯1âŠ‘(0â€¿1â€¿0â€¿(âŠ‘ğ•©)â€¿(â‰0â€¿0)) {
		ixâ€¿dirâ€¿xiâ€¿xpâ€¿evxâ†ğ•©
		pâ†ğ•¨
		naccâ† TestConds âŸ¨
			(0<dirÃ—p-xp)â€¿		{ğ•¤â‹„dirâ€¿ixâ€¿pâ€¿evx}		# Continues in the same direction as before, update xi & xp
			{qdcâ‰¥dirÃ—-p-xp}â€¿	{ğ•¤â‹„dirâ€¿xiâ€¿xpâ€¿evx}		# Opposite direction, below threshold, keep previous xi & xp
											{ğ•¤â‹„(-dir)â€¿ixâ€¿pâ€¿((xiâ€¿dir)âˆ¾evx)} # Opposite direction, above threshold, change direction
		âŸ©
		(ix+1)âˆ¾nacc
	}Â´ âŒ½ğ•©â‹„
}
pks â† 0.20 Peaks cl 
pixâ†0âŠ‘Ë˜pks
pcpixâ†pixâŠ¸âŠcl
0.15>|-Ëpcpixâ‰Â»pcpix
ixsâ†â†•â‰ cl
plt â† Gnuplot "
	title 'ZigZag Algorithm' font ',18'
	terminal wxt size 1800,900
	style line 1 lt rgb 'black' lw 1"
plt.Plot (â‰>pixâ€¿pcpix)â€¿" lw 2 lc rgb 'red' pt 7 ps 3"
plt.Plot (â‰>ixsâ€¿cl)â€¿"lw 1 lc rgb 'black' with lines"
"gnuplot-zigzag-1.txt" â€¢file.Chars plt.Debug @
â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-zigzag-1.txt"
18541.28 Ã· 18325.11 -1 






stds â† 14 WStd cl
ixsâ†(â†•â‰ cl)
â‰>ixsâ€¿cl
emaBo â† 21 Ema cl
boLâ€¿boH â† (<emaBo) +Ë˜ âŸ¨Â¯1,1âŸ©Ã—Â¨<stds
#â‰ bol
cl
#â‰>ixsâ€¿emaBo

plt â† Gnuplot "
  title 'Price and EMA' font ',18'
	terminal wxt size 1300,600
	style line 5 lt rgb 'cyan' lw 3 pt 6
"
4â†‘â‰>ixsâ€¿cl
plt.Plot (â‰>ixsâ€¿cl)â€¿"lw 0.5 lc rgb 'blue' with lines"
plt.Plot (â‰>ixsâ€¿emaBo)â€¿"lw 0.5 lc rgb 'black' with lines"
plt.Plot (â‰>ixsâ€¿boL)â€¿"lw 0.5 lc rgb 'green' with lines"
plt.Plot (â‰>ixsâ€¿boH)â€¿"lw 0.5 lc rgb 'red' with lines"
# ZigZag like neurotrader


"gnuplot-example-1.txt" â€¢file.Chars plt.Debug @

0.1 {ğ•©} cl



#âŸ¨4â€¿4,0â€¿âˆâŸ© âŠ‘ dcv


#hwâ†"h"
#hwâ†©"Hello "â€¿"World!"
#â¥ŠÂ¨hw
 
