
âŸ¨GnuplotâŸ© â† â€¢Import "Gnuplot.bqn"
csvâ†â€¢Import "bqn-libs/csv.bqn"
strâ†â€¢Import "bqn-libs/strings.bqn"
âŸ¨JParseâ‡Parse,JExportâ‡ExportâŸ©â†â€¢Import "bqn-libs/json.bqn"
âŸ¨Split , Join,  SplitL, JoinLâŸ©â†â€¢Import "bqn-libs/csv.bqn"
âŸ¨MP, Cholesky,InverseâŸ©â†â€¢Import "bqn-libs/matrix.bqn"
#1â€¿1 MP 2â€¿2â¥Š4
âŸ¨FmtNs, GLine, WMean, Ema, Var, WVar, WStd, GBars, CumBins, CumBinsPct, HBins, Hist, PHistâŸ©â†â€¢Import "pk-libs.bqn"
ge â† â€¢Import "genetic.bqn"

NSValues â† {ğ•©âŠ¸â€¢ns.GetÂ¨ (â€¢ns.Keys ğ•©)} 
Test â† {fnâ†{Condâ€¿Act ğ•Š else: Condâ—¶Elseâ€¿Act}Â´ğ•© â‹„ Fn@}
IfElse â† {condâ€¿Trueâ€¿False: condâ—¶Falseâ€¿True @}
NFmt â† âŸ¨"Â¯"âŸ©â€¿âŸ¨"-"âŸ©âŠ¸str.ReplaceAll âˆ˜ â€¢Fmt
TFmt â† {râ†ğ•©â‹„â‰>ğ•¨ {ğ•Â¨ ğ•©âŠË˜r}Â¨ (â†•â‰ ğ•¨)}
jsondirâ† "/media/mu6mula/Data/Crypto-Data-Feed/freq-user-data/data/binance/"
LdJson â†{ 
	>JParse â€¢FChars jsondirâˆ¾(âŠ‘ğ•©)âˆ¾"_"âˆ¾(1âŠ‘ğ•©)âˆ¾"-"âˆ¾(2âŠ‘ğ•©)âˆ¾".json"
}
LdJsLc â† {â‹†â¼ Â¯2âŠË˜ ğ•¨ LdJson ğ•©â€¿"USDT"}
Qcsv â† (âŠ£â€¢FLinesâŸœ(csv.JoinL NFmtÂ¨)) 

#3â†‘ lohlcv â† (âŠ‘Ë˜ âˆ¾Ë˜ (â‹†â¼1â€¿2â€¿3â€¿4âŠ¸âŠË˜)) LdJson "AVAX"â€¿"USDT"â€¿"8h" 
#10â†‘ 2â€¿3âŠ¸âŠË˜ ohlcv
#10â†‘ klines â† LdJson (<âŠ¸âˆ¾âŸœ("USDT"â€¿"1d")) "ETH"
#10â†‘Â¨ ((((Â«Â«)âˆ¾Ë˜Â») (0â€¿0âˆ¾2âŠ¸â†•) ))Â¨ 2â€¿3 âŠË˜Â¨ <klines 
#hâ€¿l â† 2â€¿3 âŠË˜Â¨ <klines 
#10â†‘ âˆ¾Ë˜Â´ c5hâ€¿c5l â† âŒˆâ€¿âŒŠ { ğ• Â´Ë˜ ğ•© }Â¨ ((((Â«Â«)âˆ¾Ë˜Â») (0â€¿0âˆ¾2âŠ¸â†•) ))Â¨ hâ€¿l


#################################################################
### Ichimoku Cloud 
#################################################################
XIndicators â† {
	âŸ¨klinesâŸ© â‡ ğ•©
	iparams â‡ ğ•¨â‹„
	tenkanNâ€¿kijunNâ€¿senkBNâ€¿cloudN â† iparams
	indicators â‡ {ğ•¤
		tenkan â‡ Ã·âŸœ2 +Â´âŒˆâ€¿âŒŠ {(0â¥ŠËœtenkanN-1)âˆ¾ğ• ËË˜ tenkanNâ†•ğ•©}Â¨ â‹ˆËâ‰2â€¿3âŠ¸âŠË˜klinesâ‹„
		kijun â‡ Ã·âŸœ2 +Â´âŒˆâ€¿âŒŠ {(0â¥ŠËœkijunN-1)âˆ¾ğ• ËË˜ kijunNâ†•ğ•©}Â¨ â‹ˆËâ‰2â€¿3âŠ¸âŠË˜klinesâ‹„
		senkouA â‡ (cloudNâ¥Š0)Â» Ã·âŸœ2 tenkan + kijunâ‹„
		senkouB â‡ (cloudNâ¥Š0)Â» Ã·âŸœ2 +Â´âŒˆâ€¿âŒŠ {(0â¥ŠËœsenkBN-1)âˆ¾ğ• ËË˜ senkBNâ†•ğ•©}Â¨ â‹ˆËâ‰2â€¿3âŠ¸âŠË˜klinesâ‹„
	#	tenkanâ€¿kijunâ€¿senkouAâ€¿senkouB
		c5hâ€¿c5l â† âŒˆâ€¿âŒŠ { ğ• Â´Ë˜ ğ•© }Â¨ ((((Â«Â«)âˆ¾Ë˜Â») (0â€¿0âˆ¾2âŠ¸â†•) ))Â¨ hâ€¿l â† 2â€¿3 âŠË˜Â¨ <klines 
		wfhâ€¿wfl â‡ >â€¿< {âŠ‘âˆ˜ğ• Ëğ•©}Â¨ hâ€¿l â‹ˆÂ¨ c5hâ€¿c5l
		#wfraâ‡ âŠ‘ +Â´ 1â€¿Â¯1 Ã—Â¨
	}@
}
#{ğ•©.indicators.wfl} {tenkanNâ‡20â‹„kijunNâ‡60â‹„senkBNâ‡120â‹„cloudNâ‡30} XIndicators {klinesâ‡LdJson "ADA"â€¿"USDT"â€¿"1d"}
#{ğ•©.indicators.wfra} {tenkanNâ‡20â‹„kijunNâ‡60â‹„senkBNâ‡120â‹„cloudNâ‡30} XIndicators {klinesâ‡LdJson "ADA"â€¿"USDT"â€¿"1d"}

XStra2 â† { 
	âŸ¨klines,indicators,iparamsâŸ© â† ğ•©
	âŸ¨tenkan,kijun,senkouA,senkouBâŸ© â† indicators
	skipN â† ğ•¨
	ixs â† â†•â‰ klines
	senkouUpâ€¿senkouDn â† âŒˆâ€¿âŒŠ {ğ• Â´ ğ•©}Â¨ < senkouAâ€¿senkouB
	closeâ†Â¯2âŠË˜klinesâ‹„ # lnclose â† â‹†â¼ close
	xinsig â‡ (skipN < ixs) âˆ§ (tenkan > kijun) âˆ§ (close > senkouUp) âˆ§ (close > tenkan)
#	xoutsig â†  (close < senkouUp)   #âˆ¨ (tenkan < kijun)
	xenter â‡ (âŠ¢âˆ§(Â¬Â»)) xinsig

	xexit â†  (close < senkouUp)   #âˆ¨ (tenkan < kijun)
	posinxâ‡ /xenter
	poslensâ‡1â†“(((+Â´âˆ˜Â¬âˆ¨`)))Â¨ (+`xenter) âŠ” xexit
	posoutxâ‡ ((â‰ klines)-1)âŒŠposinx+poslens
	xio â‡ (posinxâ‰posoutx) 
	cio â‡ xio âŠ close 
	pnlâ‡--Ë â‹†â¼cio
	cumpnlâ‡+`pnl
}

XStra â† {ğ•¤
	âŸ¨klines,indicators,iparamsâŸ© â‡ ğ•©
#	âŸ¨klines,indicators,iparamsâŸ© â† {tenkanNâ‡20â‹„kijunNâ‡60â‹„senkBNâ‡120â‹„cloudNâ‡30} XIndicators {klinesâ‡LdJson "ADA"â€¿"USDT"â€¿"1d"}
	âŸ¨tenkan,kijun,senkouA,senkouB,wflâŸ© â† indicators
	lows â† 3âŠ‘Ë˜klines
	tsâ€¿openâ€¿highâ€¿lowâ€¿closeâ€¿vlume â† <Ë˜â‰klines
	iwflâ†/wfl
	lwfrT â† (âˆ¾Ë˜âŸœ(âŠâŸœlow)) iwfl
	dwflâ†(-âŸœÂ»)/wflâˆ¾1â‹„
	wfrlowâ† ((dwfl)/(0âˆ¾iwfl))âŠlow
	enterSigsâ† (tenkan>kijun)âˆ§(close>senkouaâŒˆsenkoubâŒˆkijunâŒˆtenkan)
	exitSigs â† (close<senkouaâŒˆsenkoub)âˆ¨(tenkan<kijun)
	#+Â´wfrlows > close
	skipNâ†âŒˆÂ´NSValues iparamsâ‹„
	entpriceâ†0â‹„ninâ†0â‹„nexâ†0â‹„
  inposâ€¿pnlâ†res â‡ {ğ•¤
			inposâ€¿pnl â‡ <Ë˜â‰ (skipNâ€¿2â¥Š0) âˆ¾ > (<0â€¿0) {ğ•¤
					inposâ€¿pnl â† ğ•¨ â‹„ closeâ€¿entersigâ€¿exitsigâ€¿sl â† ğ•©
					{
							((Â¬inpos) âˆ§ entersig âˆ§ (nex> iparams.tenkanN) ) ? ({ğ•¤
															 entpriceâ†©closeâ‹„ninâ†©0â‹„#wfslâ†©wfrlow â‹„ #â‹„ pnlâ†©0 â‹„
															 #â€¢Show "Enter entprice: "âˆ¾(Nfmt entprice)âˆ¾"  price: "âˆ¾ (NFmt close)âˆ¾"  pnl: "âˆ¾(NFmt pnl)
															 #â€¢Show "Entering..."
															 1â€¿0
							}@);
#							(inpos âˆ§ Â¬exitsig) ? ({ğ•¤
#															 #â€¢Show "Carry on entprice: "âˆ¾(Nfmt entprice)âˆ¾"  price: "âˆ¾ (NFmt close)âˆ¾"  pnl: "âˆ¾(NFmt pnl)
#									#wfslâŒˆâ†©wfrlow
#									{ğ•¤â‹„inposâ€¿0}@
#							}@)
							(inpos) ? ({ğ•¤
									(exitsigâˆ¨(1âˆ¨(close>entprice)âˆ§(close<sl))) ? ({ğ•¤
											 #inposâ†©0 #â‹„ pnlâ†© â‹†â¼ close Ã· entpriceâ‹„                                   
											 pnl â† (â‹†â¼ closeÃ·entprice)
											 nexâ†©0â‹„
											 #â€¢Show "Exit entprice: "âˆ¾(Nfmt entprice)âˆ¾"  price: "âˆ¾ (NFmt close)âˆ¾"  pnl: "âˆ¾(NFmt pnl)
											 #entpriceâ†©0
											 0â€¿pnl
									}@);
									{ğ•¤â‹„
											nin 1âŠ¸+â†©
											inposâ€¿0
									}@
							}@);
							{ğ•¤â‹„
									nex 1âŠ¸+â†©
									inposâ€¿0
							}@
					}
				}` <Ë˜ skipNâ†“ âŠ¢ closeâˆ¾Ë˜enterSigsâˆ¾Ë˜exitSigsâˆ¾Ë˜0â€¿0Â»wfrlow
			cumpnl â‡ +` pnl
		}@
		+Â´inpos
}
		
âŸ¨klines,indicators,resâŸ©â†XStra {tenkanNâ‡50â‹„kijunNâ‡100â‹„senkBNâ‡240â‹„cloudNâ‡60} XIndicators {klinesâ‡LdJson "INJ"â€¿"USDT"â€¿"1d"}
#wsâ€¿pwl â† 1000â€¿âˆ
PlotSingle â† { ğ•¤
	âŸ¨klines,indicators,resâŸ©â† ğ•©â‹„ 	wsâ€¿pwl â† ğ•¨â‹„
	âŸ¨tenkan,kijun,senkoua,senkoub,wfl,wfhâŸ© â† indicators
	tsâ€¿openâ€¿highâ€¿lowâ€¿closeâ€¿volume â†<Ë˜â‰ klines
	wlâ† pwlâŒŠ (â‰ klines) - ws
	Wwâ†(wlâŠ¸â†‘wsâŠ¸â†“) â‹„ Wi â† (({âˆ§Â´ (â‰¥âŸœws)â€¿((ws+wl)âŠ¸â‰¥) {ğ• ğ•©}Â¨ ğ•©} (<âŠ‘Ë˜))âŠ¸/)

	iwflâ†/wfl
	lwfrT â† (âˆ¾Ë˜âŸœ(âŠâŸœlow)) iwfl
	dwflâ†(-âŸœÂ»)/wflâˆ¾1â‹„
	wfrlowâ† ((dwfl)/(0âˆ¾iwfl))âŠlow


	xin â† /posin â† ((Â¬Â»)âˆ§âŠ¢) res.inpos
	xout â† /posout â† (Â»âˆ§Â¬) res.inpos
	ymin â† âŒŠÂ´Ww lowâ‹„ymaxâ† âŒˆÂ´Ww high
	#closeâ†Â¯2âŠË˜klinesâ‹„ # lnclose â† â‹†â¼ close
		ixs â† â†•â‰ klinesâ‹„
		plt â† Gnuplot "
			title 'Ichimoku Cloud' font ',18'
			terminal wxt size 2400,900
			y2tics 0.20 nomirror tc lt 2
			y2range [-1:10]
			xrange ["âˆ¾(NFmt ws)âˆ¾":"âˆ¾(NFmt ws+wl-1)âˆ¾"]
			yrange ["âˆ¾(NFmt ymin)âˆ¾":"âˆ¾(NFmt ymax)âˆ¾"]
			grid
			parametric
			style line 5 lt rgb 'cyan' lw 3 pt 6"
		plt.Plot (Ww â‰>ixsâ€¿senkouAâ€¿senkouB)â€¿" with filledcurves fs solid 0.1"
		plt.Plot (Ww â‰>ixsâ€¿close)â€¿"lw 2 lc rgb 'black' with lines"
#		#plt.Plot (â‰>ixsâ€¿high)â€¿"lw 1 lc rgb 'orange' with lines"
		#plt.Plot (â‰>ixsâ€¿low)â€¿"lw 1 lc rgb 'green' with lines"
		plt.Plot (Ww â‰>ixsâ€¿tenkan)â€¿"lw 1 lc rgb '#5555CC' with lines"
		plt.Plot (Ww â‰>ixsâ€¿kijun)â€¿"lw 1 lc rgb 'red' with lines"
		plt.Plot (Ww â‰>ixsâ€¿senkouA)â€¿"lw 1 lc rgb 'gray' with lines"
		plt.Plot (Ww â‰>ixsâ€¿senkouB)â€¿"lw 1 lc rgb 'gray' with lines"
		plt.Plot (Wi â‰>ixsâ€¿res.cumpnl)â€¿"lw 5 lc rgb 'orange' with steps axes x1y2"
		plt.Plot (Wi lwfrT)â€¿"lw 5 lc rgb 'gray' with points"
		#plt.Plot (Ww â‰>ixsâ€¿wfrlow)â€¿"lw 1 lc rgb 'black' with lines"
		plt.Plot ((xin)(âŠ£âˆ¾Ë˜âŠ)close)â€¿"lw 5 lc rgb 'black' with points"
		plt.Plot ((xout)(âŠ£âˆ¾Ë˜âŠ)close)â€¿"lw 5 lc rgb 'blue' with points"
		"gnuplot-ichimoku-1.txt" â€¢file.Chars plt.Debug @
		â€¢SH "gnuplot"â€¿"-persist"â€¿"gnuplot-ichimoku-1.txt"
}

0â€¿âˆ PlotSingle XStra {tenkanNâ‡15â‹„kijunNâ‡35â‹„senkBNâ‡120â‹„cloudNâ‡30}âŠ¸XIndicators {klinesâ‡ğ•©}LdJson "REN"â€¿"USDT"â€¿"8h"

XStats â‡ {
		âŸ¨inpos,pnl,cumpnlâŸ© â† ğ•©
		xin â† /posin â† ((Â¬Â»)âˆ§âŠ¢) inpos
		xout â† /posout â† (Â»âˆ§Â¬) inpos
		retâ‡Â¯1âŠ‘0âˆ¾cumpnl
		ntradesâ‡â‰ xoutâ‹„nwinsâ‡+Â´0<xoutâŠpnlâ‹„nlossesâ‡ntrades-nwinsâ‹„winratioâ‡nwinsÃ·ntradesâ‹„
		winsâ†(0âŠ¸<âŠ¸/)xoutâŠpnlâ‹„lossesâ†(0âŠ¸â‰¥âŠ¸/)xoutâŠpnlâ‹„avgwinâ‡(+Â´Ã·â‰ )winsâ‹„avglossâ‡(+Â´Ã·â‰ )lossesâ‹„
		bottompnlâ‡âŒŠÂ´cumpnl
		maxpnlâ†âŒˆ`cumpnl
		ddnâ†-maxpnl-cumpnl
		maxddnâ‡âŒŠÂ´ddn
		volâ‡âˆšVar pnl
		sharpeâ‡retÃ·vol
		toppnlâ‡âŒˆÂ´maxpnl
}

########################################
### Test TOP 100 coins 
(â‰ âŠ¸âˆ¾) top100 â† â€¢FLines "/media/mu6mula/Data/Crypto-Data-Feed/top100-1d.csv"
(â‰ âŠ¸âˆ¾) binance1d â† â€¢FLines "/media/mu6mula/Data/Crypto-Data-Feed/binance-1d.csv"


#assets â† 5â†‘ top100
#tfr â† "8h"
XStatsRep â† { ğ•¤
	tfr â† ğ•¨
	assets â† ğ•©
#{XStra {tenkanNâ‡20â‹„kijunNâ‡60â‹„senkBNâ‡120â‹„cloudNâ‡30}âŠ¸XIndicators {klinesâ‡LdJson ğ•©} ğ•©â€¿"USDT"â€¿tfr}Â¨ assets
  resâ† ({ğ•©.res} XStraâŸœ({tenkanNâ‡20â‹„kijunNâ‡60â‹„senkBNâ‡120â‹„cloudNâ‡30}âŠ¸XIndicators  {â€¢Showğ•©â‹„klinesâ‡LdJson ğ•©â€¿"USDT"â€¿tfr}))Â¨ assets

 #{klinesâ‡ğ•©â‹„indicators â‡ (20â€¿60â€¿120â€¿30âŠ¸XIndicators ğ•©)}Â¨ klines
	stats â† XStatsÂ¨ res
	((<"")âˆ¾assets) âˆ¾Ë˜((0âŠ¸âŠË˜âŠ‘)âˆ¾(>(1âŠ¸âŠË˜)Â¨)) {kâ†â€¢ns.Keys ğ•©â‹„ kâ‰Ë˜ğ•©âŠ¸â€¢ns.GetÂ¨ k}Â¨ stats
}

	SaveStatsRep â† {tfrâ†ğ•¨â‹„("binance-"âˆ¾tfrâˆ¾"-Ichimoku.csv") â€¢FLines csv.JoinL ((0âŠ¸âŠ)âˆ¾(âŠ¢â€¿NFmtâ€¿NFmtâ€¿NFmtâ€¿NFmtâ€¿NFmtâ€¿NFmtâ€¿NFmtâ€¿NFmtâ€¿NFmtâ€¿NFmtâ€¿NFmtâ€¿NFmtâŠ¸TFmt 1âŠ¸â†“)) ğ•©}
"4h" (âŠ£ SaveStatsRep XStatsRep) binance1d
Obj â† {+Â´ 1âŠ‘Ë˜ 1â†“ "1d" XStatsRep binance1d

#1â†“ tres

#+Â´Â¯1âŠ‘Ë˜tres
#"top100-Ichimoku.csv" â€¢FLines csv.JoinL ("ASSET"â€¿"PNL")âˆ¾  âŠ¢â€¿NFmt TFmt tres 
#tres

#"BTC"â€¿"USDT" PlotIchimoku "1d"
###
